<!DOCTYPE html>
<!--
    LucidEd - Lucid Edit, a browser-based text editor
    Copyright (C) 2012  David Duong

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>LucidEd - Lucid Edit, a browser-based text editor</title>

    <link rel="stylesheet" href="lib/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="style/style.css">

<script type="text/javascript">
<!--
var pathname = location.pathname;
var dojoConfig = {
	async: true,
	isDebug: true,
	packages: [{
		name: "lucided",
		location: pathname.replace(/\/[^/]*$/, '/lib/lucided')
	},{
		name: "codemirror",
		location: pathname.replace(/\/[^/]*$/, '/lib/codemirror')
	},{
		name: "pagedown",
		location: "//cdnjs.cloudflare.com/ajax/libs/pagedown/1.0"
	},{
		name: "coffee-script",
		location: "//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.3.3"
	}]
};
// -->
</script>
    <link rel="stylesheet" href="lib/dijit/themes/nihilo/nihilo.css">
    <script src="lib/dojo/dojo.js"></script>

<!--
    <script src="//ajax.googleapis.com/ajax/libs/dojo/1.8.2/dojo/dojo.js"></script>
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.8.2/dijit/themes/nihilo/nihilo.css">
-->
<script type="text/javascript">
<!--
require([
    "dojo/keys",
    "dojo/on",
    "lucided/REPL",
    "lucided/cmWrapperFactory",
    "codemirror/lib/codemirror",
    "dojo/domReady!"
], function (keys, on, REPL, wrapper) {
    "use strict";
    var repl = new REPL({}, "repl");
    repl.startup();

    var editor = CodeMirror(document.body, {
//        extraKeys: {"Alt-Space": function () {}},
        lineNumbers: true,
        autofocus: true
    });

    on(document.body, "keydown", function (evt) {
        if (evt.keyCode === keys.ESCAPE) {
            // TODO: repl.set('selected', REPL.console);
            var select = repl.hideTab;
            select = (repl.tabContainer.selectedChildWidget != repl.hideTab)? repl.hideTab: repl.consoleTabContents;
	        repl.tabContainer.selectChild(select);
        }
    }); 

    on(repl, "blur", function () {
        // TODO: repl.set('selected', REPL.hide);
        repl.tabContainer.selectChild(repl.hideTab);
    });

    on(repl.hideTab, "show", function () {
        editor.focus();
    });

	repl.createTab({
		title: "Help",
		onShow: function() {
			var self = this;
			require([
				"dojo/request",
				"pagedown/Markdown.Converter"
			], function (request) {
				request('README.md').then(function (content) {
					var converter = new Markdown.Converter();
					self.set('content', converter.makeHtml(content))
				});
			});
		}
	});

	if (!('lucid_init' in window.localStorage)) {
		window.localStorage['lucid_init'] = "lucid.request 'README.markdown'";
	}

	window.lucid = wrapper(editor, repl);

	// Execute the command displaying results in REPL dijit
	repl.eval('lucid localStorage.lucid_init');
	repl.tabContainer.selectChild(repl.hideTab);
});
// -->
</script>

</head>
<body class="nihilo">
    <div id="repl"></div>
</body>
</html>
